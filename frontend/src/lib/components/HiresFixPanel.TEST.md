# HiresFixPanel 组件测试文档

## 测试概述

本文档提供 `HiresFixPanel` 组件的完整测试指南，包括功能测试、UI 测试和集成测试。

## 测试清单

### ✅ 基础功能测试

#### 1. 组件渲染
- [ ] 组件正常加载和渲染
- [ ] 标题显示正确："🔍 高分辨率修复 (Hires.fix)"
- [ ] 重置按钮显示正确
- [ ] 提示信息正确显示

#### 2. 图像上传功能
- [ ] 点击"选择图像"按钮触发文件选择
- [ ] 成功上传有效图像文件（PNG, JPG, WebP）
- [ ] 图像正确显示在预览 Canvas 中
- [ ] 图像按比例缩放到最大 512px
- [ ] 上传后按钮文本变为"更换图像"
- [ ] 拒绝非图像文件并显示错误提示
- [ ] 图像加载失败时显示错误提示

#### 3. Prompt 输入
- [ ] Prompt 文本框正常输入
- [ ] Negative Prompt 文本框正常输入
- [ ] Prompt 为空时"开始生成"按钮禁用
- [ ] 输入 Prompt 后按钮启用

### ✅ 参数配置测试

#### 4. 第一阶段步数
- [ ] 数字输入框正常工作
- [ ] 最小值限制为 10
- [ ] 最大值限制为 50
- [ ] 默认值为 20
- [ ] 只接受整数输入

#### 5. 高分辨率步数
- [ ] 数字输入框正常工作
- [ ] 最小值限制为 5
- [ ] 最大值限制为 50
- [ ] 默认值为 15
- [ ] 只接受整数输入

#### 6. Upscaler 选择
- [ ] 下拉菜单正常显示
- [ ] 显示所有可用选项（6 个）
- [ ] 默认选择 "Latent (快速)"
- [ ] 可以切换不同的 Upscaler
- [ ] 选项标签正确显示

#### 7. 放大倍数滑块
- [ ] 滑块正常拖动
- [ ] 范围：1.0x - 4.0x
- [ ] 步进：0.1
- [ ] 默认值：2.0x
- [ ] 实时显示当前值
- [ ] 预览提示更新（"原始图像将被放大 Xx"）

#### 8. 降噪强度滑块
- [ ] 滑块正常拖动
- [ ] 范围：0.0 - 1.0
- [ ] 步进：0.05
- [ ] 默认值：0.7
- [ ] 实时显示当前值（百分比格式）
- [ ] 提示信息正确显示

#### 9. 引导强度滑块
- [ ] 滑块正常拖动
- [ ] 范围：1.0 - 20.0
- [ ] 步进：0.5
- [ ] 默认值：7.5
- [ ] 实时显示当前值

### ✅ 生成功能测试

#### 10. 从头生成（无源图像）
- [ ] 输入 Prompt 后可以开始生成
- [ ] 点击"开始生成"按钮触发 API 调用
- [ ] 请求体不包含 `image` 字段
- [ ] 加载状态正确显示
- [ ] 按钮显示"生成中..."和加载动画
- [ ] 按钮在生成期间禁用

#### 11. 基于源图像生成
- [ ] 上传图像后可以开始生成
- [ ] 请求体包含 Base64 编码的图像
- [ ] 所有参数正确传递到 API
- [ ] 生成过程正常进行

#### 12. 进度显示
- [ ] 开始生成时显示进度区域
- [ ] 显示当前阶段："第一阶段：低分辨率生成"
- [ ] 显示加载动画
- [ ] 进度条正确更新（如果有进度数据）
- [ ] 完成时显示"完成"

#### 13. 结果显示
- [ ] 生成成功后显示结果区域
- [ ] 结果图像正确显示
- [ ] 显示"✨ 生成结果"标题
- [ ] 显示下载按钮
- [ ] 显示放大倍数提示
- [ ] 结果图像有正确的边框和样式

#### 14. 下载功能
- [ ] 点击下载按钮触发下载
- [ ] 文件名格式正确：`hires_fix_result_[timestamp].png`
- [ ] 下载的是完整的高分辨率图像
- [ ] 图像格式正确（PNG）

### ✅ 错误处理测试

#### 15. 验证错误
- [ ] Prompt 为空时显示验证错误
- [ ] 错误提示包含建议操作
- [ ] 上传无效文件时显示错误
- [ ] 图像加载失败时显示错误

#### 16. API 错误
- [ ] 网络错误时显示友好提示
- [ ] HTTP 错误状态正确处理
- [ ] 后端返回错误时显示错误信息
- [ ] 错误提示包含解决建议
- [ ] 错误信息显示在控制台

#### 17. 错误恢复
- [ ] 错误后可以修改参数重试
- [ ] 清除错误状态正常工作
- [ ] 重置按钮清除所有错误

### ✅ UI/UX 测试

#### 18. 重置功能
- [ ] 点击重置按钮清除所有状态
- [ ] 清除源图像
- [ ] 清除结果图像
- [ ] 清除 Prompt 和 Negative Prompt
- [ ] 恢复所有参数到默认值
- [ ] 清除错误状态
- [ ] 隐藏结果区域

#### 19. 响应式设计
- [ ] 在不同屏幕尺寸下正常显示
- [ ] 移动设备上布局合理
- [ ] 滑块在小屏幕上可用
- [ ] 文本输入框自适应宽度

#### 20. 交互反馈
- [ ] 按钮悬停效果正常
- [ ] 禁用状态样式正确
- [ ] 加载状态动画流畅
- [ ] 滑块拖动流畅
- [ ] 过渡动画自然

### ✅ 集成测试

#### 21. API 集成
- [ ] API 端点正确：`/api/hires-fix`
- [ ] 请求方法：POST
- [ ] Content-Type：application/json
- [ ] 请求体格式正确
- [ ] 响应格式正确解析

#### 22. 状态管理集成
- [ ] 错误状态正确使用 `setError`
- [ ] 错误清除正确使用 `clearError`
- [ ] 错误类型正确设置
- [ ] 错误信息正确传递

#### 23. Canvas 集成
- [ ] Canvas 正确初始化
- [ ] 图像正确绘制到 Canvas
- [ ] Canvas 尺寸正确计算
- [ ] 图像缩放保持宽高比

## 测试场景

### 场景 1：快速预览生成

**步骤**：
1. 输入 Prompt："a beautiful landscape"
2. 保持默认参数（Latent, 2.0x）
3. 点击"开始生成"

**预期结果**：
- 生成成功
- 显示 2x 放大的图像
- 生成时间较短

### 场景 2：高质量图像生成

**步骤**：
1. 输入详细 Prompt
2. 选择 ESRGAN 4x 放大算法
3. 设置第一阶段步数：25
4. 设置高分辨率步数：20
5. 设置放大倍数：3.0x
6. 点击"开始生成"

**预期结果**：
- 生成高质量图像
- 细节丰富
- 生成时间较长

### 场景 3：基于现有图像的高分辨率修复

**步骤**：
1. 上传一张低分辨率图像
2. 输入描述图像内容的 Prompt
3. 设置降噪强度：0.7
4. 选择合适的 Upscaler
5. 点击"开始生成"

**预期结果**：
- 图像被放大
- 细节得到增强
- 保持原图风格

### 场景 4：错误处理

**步骤**：
1. 不输入 Prompt 直接点击生成
2. 上传非图像文件
3. 在后端服务未启动时尝试生成

**预期结果**：
- 显示相应的错误提示
- 提供解决建议
- 不会崩溃

### 场景 5：参数调整

**步骤**：
1. 调整各个参数滑块
2. 观察实时值更新
3. 切换不同的 Upscaler
4. 修改步数

**预期结果**：
- 所有参数实时更新
- UI 响应流畅
- 值在有效范围内

## API 测试

### 请求示例

```bash
# 从头生成
curl -X POST http://localhost:8000/api/hires-fix \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "a beautiful mountain landscape",
    "negative_prompt": "blurry, low quality",
    "first_pass_steps": 20,
    "hires_steps": 15,
    "upscaler": "Latent",
    "upscale_by": 2.0,
    "denoising_strength": 0.7,
    "guidance_scale": 7.5
  }'

# 基于源图像
curl -X POST http://localhost:8000/api/hires-fix \
  -H "Content-Type: application/json" \
  -d '{
    "image": "data:image/png;base64,...",
    "prompt": "enhance details",
    "first_pass_steps": 20,
    "hires_steps": 15,
    "upscaler": "ESRGAN_4x",
    "upscale_by": 2.0,
    "denoising_strength": 0.7,
    "guidance_scale": 7.5
  }'
```

### 预期响应

```json
{
  "success": true,
  "image": "data:image/png;base64,..."
}
```

### 错误响应

```json
{
  "success": false,
  "message": "错误描述"
}
```

## 性能测试

### 测试指标

- [ ] 组件初始化时间 < 100ms
- [ ] 图像上传和预览 < 500ms
- [ ] UI 交互响应 < 50ms
- [ ] 参数更新实时性良好
- [ ] 内存使用合理（无泄漏）

### 压力测试

- [ ] 上传大尺寸图像（4K+）
- [ ] 连续多次生成
- [ ] 快速切换参数
- [ ] 长时间运行稳定性

## 浏览器兼容性

- [ ] Chrome/Edge (最新版本)
- [ ] Firefox (最新版本)
- [ ] Safari (最新版本)
- [ ] 移动浏览器（iOS Safari, Chrome Mobile）

## 自动化测试建议

### 单元测试

```typescript
// 测试参数验证
describe('HiresFixPanel - Validation', () => {
  test('should disable generate button when prompt is empty', () => {
    // 测试逻辑
  });
  
  test('should show error when uploading invalid file', () => {
    // 测试逻辑
  });
});

// 测试 API 调用
describe('HiresFixPanel - API', () => {
  test('should call API with correct parameters', () => {
    // 测试逻辑
  });
  
  test('should handle API errors gracefully', () => {
    // 测试逻辑
  });
});
```

### 集成测试

```typescript
// 测试完整生成流程
describe('HiresFixPanel - Integration', () => {
  test('should complete full generation workflow', async () => {
    // 1. 输入 Prompt
    // 2. 配置参数
    // 3. 点击生成
    // 4. 等待完成
    // 5. 验证结果
  });
});
```

## 测试报告模板

```markdown
## 测试报告

**测试日期**: YYYY-MM-DD
**测试人员**: [姓名]
**组件版本**: v1.0.0

### 测试结果总览
- 总测试项: XX
- 通过: XX
- 失败: XX
- 跳过: XX

### 失败项详情
1. [测试项名称]
   - 预期: [预期结果]
   - 实际: [实际结果]
   - 原因: [失败原因]

### 性能指标
- 组件加载时间: XXms
- 图像上传时间: XXms
- API 响应时间: XXms

### 建议
- [改进建议 1]
- [改进建议 2]
```

## 常见问题排查

### 问题 1：组件不显示
- 检查导入路径是否正确
- 检查 Svelte 配置
- 查看浏览器控制台错误

### 问题 2：图像上传失败
- 检查文件类型
- 检查文件大小
- 查看错误提示

### 问题 3：API 调用失败
- 检查后端服务是否运行
- 检查 API 端点是否正确
- 查看网络请求详情

### 问题 4：生成结果不理想
- 调整 Prompt 描述
- 尝试不同的 Upscaler
- 增加步数
- 调整降噪强度

## 测试完成标准

所有测试项通过后，组件可以认为已准备好用于生产环境：

- ✅ 所有功能测试通过
- ✅ 所有错误处理测试通过
- ✅ UI/UX 测试通过
- ✅ 集成测试通过
- ✅ 性能测试达标
- ✅ 浏览器兼容性测试通过
- ✅ 文档完整

## 下一步

测试完成后：
1. 记录测试结果
2. 修复发现的问题
3. 更新文档
4. 准备集成到主应用
