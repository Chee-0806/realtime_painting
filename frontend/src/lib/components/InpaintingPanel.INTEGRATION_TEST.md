# InpaintingPanel APIé›†æˆæµ‹è¯•æ–‡æ¡£

## æµ‹è¯•ç›®æ ‡

éªŒè¯InpaintingPanelç»„ä»¶ä¸åç«¯Inpainting APIçš„å®Œæ•´é›†æˆï¼Œç¡®ä¿ï¼š
1. å›¾åƒå’Œè’™ç‰ˆçš„Base64è½¬æ¢æ­£ç¡®
2. APIè°ƒç”¨é€»è¾‘å®Œæ•´
3. åŠ è½½çŠ¶æ€æ˜¾ç¤ºæ­£å¸¸
4. é”™è¯¯å¤„ç†å®Œå–„
5. å®Œæ•´çš„Inpaintingæµç¨‹å¯ç”¨

## æµ‹è¯•ç¯å¢ƒ

- å‰ç«¯ï¼šSvelteç»„ä»¶
- åç«¯ï¼šFastAPI `/api/inpaint` ç«¯ç‚¹
- ä¾èµ–ï¼šErrorHandlerç»„ä»¶ã€store.ts

## åŠŸèƒ½éªŒè¯æ¸…å•

### âœ… 1. å›¾åƒå’Œè’™ç‰ˆçš„Base64è½¬æ¢

**å®ç°ä½ç½®**ï¼š
- æºå›¾åƒï¼š`handleFileSelect()` å‡½æ•°ä½¿ç”¨ `FileReader.readAsDataURL()` 
- è’™ç‰ˆå›¾åƒï¼š`getMaskDataURL()` å‡½æ•°ä½¿ç”¨ `canvas.toDataURL('image/png')`

**éªŒè¯ç‚¹**ï¼š
- [x] æºå›¾åƒæ­£ç¡®è½¬æ¢ä¸ºBase64 DataURLæ ¼å¼
- [x] è’™ç‰ˆCanvasæ­£ç¡®è½¬æ¢ä¸ºBase64 PNGæ ¼å¼
- [x] Base64å­—ç¬¦ä¸²åŒ…å«æ­£ç¡®çš„MIMEç±»å‹å‰ç¼€

**ä»£ç ç‰‡æ®µ**ï¼š
```typescript
// æºå›¾åƒè½¬æ¢ï¼ˆåœ¨handleFileSelectä¸­ï¼‰
reader.readAsDataURL(file);  // ç»“æœï¼šdata:image/png;base64,xxx

// è’™ç‰ˆè½¬æ¢
function getMaskDataURL(): string {
  return maskCanvas.toDataURL('image/png');  // ç»“æœï¼šdata:image/png;base64,xxx
}
```

### âœ… 2. APIè°ƒç”¨é€»è¾‘

**å®ç°ä½ç½®**ï¼š`performInpainting()` å‡½æ•°

**éªŒè¯ç‚¹**ï¼š
- [x] æ­£ç¡®æ„å»ºè¯·æ±‚ä½“ï¼ˆåŒ…å«æ‰€æœ‰å¿…éœ€å‚æ•°ï¼‰
- [x] ä½¿ç”¨æ­£ç¡®çš„HTTPæ–¹æ³•ï¼ˆPOSTï¼‰
- [x] è®¾ç½®æ­£ç¡®çš„Content-Typeå¤´ï¼ˆapplication/jsonï¼‰
- [x] æ­£ç¡®å¤„ç†å“åº”æ•°æ®

**APIè¯·æ±‚æ ¼å¼**ï¼š
```typescript
{
  image: string,              // Base64 DataURL
  mask: string,               // Base64 DataURL
  prompt: string,
  negative_prompt: string,
  strength: number,           // 0.0-1.0
  guidance_scale: number,     // 1.0-20.0
  steps: number               // 10-50
}
```

**APIå“åº”æ ¼å¼**ï¼š
```typescript
{
  success: boolean,
  image?: string,             // Base64 DataURL
  message?: string            // é”™è¯¯æ¶ˆæ¯
}
```

**ä»£ç ç‰‡æ®µ**ï¼š
```typescript
const response = await fetch('/api/inpaint', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    image: sourceImage,
    mask: maskDataURL,
    prompt: prompt,
    negative_prompt: negativePrompt,
    strength: strength,
    guidance_scale: guidanceScale,
    steps: steps
  })
});
```

### âœ… 3. åŠ è½½çŠ¶æ€æ˜¾ç¤º

**å®ç°ä½ç½®**ï¼š`performInpainting()` å‡½æ•°å’ŒUIæ¨¡æ¿

**éªŒè¯ç‚¹**ï¼š
- [x] å¼€å§‹ç”Ÿæˆæ—¶è®¾ç½®loading=true
- [x] å®Œæˆæˆ–å¤±è´¥æ—¶è®¾ç½®loading=false
- [x] æŒ‰é’®æ˜¾ç¤ºåŠ è½½åŠ¨ç”»å’Œæ–‡æœ¬
- [x] åŠ è½½æ—¶ç¦ç”¨æŒ‰é’®

**ä»£ç ç‰‡æ®µ**ï¼š
```svelte
<button
  on:click={performInpainting}
  disabled={loading || !prompt.trim()}
  class="..."
>
  {#if loading}
    <span class="flex items-center justify-center gap-2">
      <div class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
      ç”Ÿæˆä¸­...
    </span>
  {:else}
    å¼€å§‹é‡ç»˜
  {/if}
</button>
```

### âœ… 4. é”™è¯¯å¤„ç†

**å®ç°ä½ç½®**ï¼šå¤šä¸ªå‡½æ•°ä¸­ä½¿ç”¨ErrorHandler

**éªŒè¯ç‚¹**ï¼š
- [x] æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆhandleFileSelectï¼‰
- [x] å›¾åƒåŠ è½½é”™è¯¯å¤„ç†ï¼ˆloadImageToCanvasï¼‰
- [x] å‚æ•°éªŒè¯ï¼ˆperformInpaintingï¼‰
- [x] ç½‘ç»œé”™è¯¯å¤„ç†ï¼ˆfetch catchï¼‰
- [x] APIé”™è¯¯å“åº”å¤„ç†ï¼ˆresponse.okæ£€æŸ¥ï¼‰
- [x] é”™è¯¯æ¶ˆæ¯æ˜¾ç¤ºï¼ˆä½¿ç”¨setErrorï¼‰
- [x] é”™è¯¯å»ºè®®æä¾›

**é”™è¯¯ç±»å‹è¦†ç›–**ï¼š
```typescript
// 1. éªŒè¯é”™è¯¯
ErrorType.VALIDATION
- æ–‡ä»¶ç±»å‹ä¸æ­£ç¡®
- æœªä¸Šä¼ å›¾åƒ
- æœªè¾“å…¥Prompt

// 2. APIé”™è¯¯
ErrorType.API
- ç½‘ç»œè¯·æ±‚å¤±è´¥
- åç«¯æœåŠ¡ä¸å¯ç”¨

// 3. ç”Ÿæˆé”™è¯¯
ErrorType.GENERATION
- Inpaintingæ‰§è¡Œå¤±è´¥
- åç«¯è¿”å›é”™è¯¯
```

### âœ… 5. å®Œæ•´æµç¨‹æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š

#### æ­¥éª¤1ï¼šä¸Šä¼ å›¾åƒ
1. ç‚¹å‡»"é€‰æ‹©å›¾åƒ"æŒ‰é’®
2. é€‰æ‹©ä¸€ä¸ªPNG/JPGå›¾åƒæ–‡ä»¶
3. éªŒè¯ï¼šå›¾åƒæ˜¾ç¤ºåœ¨Canvasä¸Š

#### æ­¥éª¤2ï¼šç»˜åˆ¶è’™ç‰ˆ
1. é€‰æ‹©"ç”»ç¬”"å·¥å…·
2. åœ¨å›¾åƒä¸Šç»˜åˆ¶çº¢è‰²åŒºåŸŸ
3. è°ƒæ•´ç”»ç¬”å¤§å°å’Œç¡¬åº¦
4. éªŒè¯ï¼šè’™ç‰ˆæ­£ç¡®æ˜¾ç¤º

#### æ­¥éª¤3ï¼šé…ç½®å‚æ•°
1. è¾“å…¥Promptï¼ˆä¾‹å¦‚ï¼š"a beautiful flower"ï¼‰
2. è¾“å…¥Negative Promptï¼ˆå¯é€‰ï¼‰
3. è°ƒæ•´é‡ç»˜å¼ºåº¦ï¼ˆ0.6ï¼‰
4. è°ƒæ•´å¼•å¯¼å¼ºåº¦ï¼ˆ7.5ï¼‰
5. è°ƒæ•´ç”Ÿæˆæ­¥æ•°ï¼ˆ20ï¼‰

#### æ­¥éª¤4ï¼šæ‰§è¡ŒInpainting
1. ç‚¹å‡»"å¼€å§‹é‡ç»˜"æŒ‰é’®
2. éªŒè¯ï¼šæŒ‰é’®æ˜¾ç¤º"ç”Ÿæˆä¸­..."å’ŒåŠ è½½åŠ¨ç”»
3. ç­‰å¾…ç”Ÿæˆå®Œæˆ
4. éªŒè¯ï¼šç»“æœå›¾åƒæ˜¾ç¤ºåœ¨ä¸‹æ–¹

#### æ­¥éª¤5ï¼šä¸‹è½½ç»“æœ
1. ç‚¹å‡»"ä¸‹è½½"æŒ‰é’®
2. éªŒè¯ï¼šå›¾åƒæ–‡ä»¶æ­£ç¡®ä¸‹è½½

## é”™è¯¯åœºæ™¯æµ‹è¯•

### åœºæ™¯1ï¼šæœªä¸Šä¼ å›¾åƒ
- æ“ä½œï¼šç›´æ¥ç‚¹å‡»"å¼€å§‹é‡ç»˜"
- é¢„æœŸï¼šæ˜¾ç¤ºé”™è¯¯æç¤º"è¯·å…ˆä¸Šä¼ å›¾åƒ"

### åœºæ™¯2ï¼šæœªè¾“å…¥Prompt
- æ“ä½œï¼šä¸Šä¼ å›¾åƒä½†ä¸è¾“å…¥Prompt
- é¢„æœŸï¼šæŒ‰é’®ç¦ç”¨ï¼Œæ— æ³•ç‚¹å‡»

### åœºæ™¯3ï¼šç½‘ç»œé”™è¯¯
- æ“ä½œï¼šæ–­å¼€ç½‘ç»œè¿æ¥åç‚¹å‡»"å¼€å§‹é‡ç»˜"
- é¢„æœŸï¼šæ˜¾ç¤ºé”™è¯¯æç¤º"Inpaintingè¯·æ±‚å¤±è´¥"

### åœºæ™¯4ï¼šåç«¯é”™è¯¯
- æ“ä½œï¼šåç«¯æœåŠ¡æœªå¯åŠ¨æ—¶ç‚¹å‡»"å¼€å§‹é‡ç»˜"
- é¢„æœŸï¼šæ˜¾ç¤ºé”™è¯¯æç¤ºå¹¶æä¾›è§£å†³å»ºè®®

## æ€§èƒ½æµ‹è¯•

### æµ‹è¯•æŒ‡æ ‡
- å›¾åƒä¸Šä¼ å“åº”æ—¶é—´ï¼š< 1ç§’
- è’™ç‰ˆç»˜åˆ¶æµç•…åº¦ï¼šæ— æ˜æ˜¾å¡é¡¿
- APIè¯·æ±‚å“åº”æ—¶é—´ï¼šå–å†³äºåç«¯ï¼ˆé€šå¸¸10-30ç§’ï¼‰
- ç»“æœæ˜¾ç¤ºå»¶è¿Ÿï¼š< 0.5ç§’

### å†…å­˜æµ‹è¯•
- ä¸Šä¼ å¤§å›¾åƒï¼ˆ2048x2048ï¼‰ï¼šæ­£å¸¸å¤„ç†
- è¿ç»­å¤šæ¬¡ç”Ÿæˆï¼šæ— å†…å­˜æ³„æ¼
- é‡ç½®åŠŸèƒ½ï¼šæ­£ç¡®æ¸…ç†èµ„æº

## é›†æˆéªŒè¯ç»“æœ

### âœ… å·²å®ç°åŠŸèƒ½

1. **Base64è½¬æ¢** âœ…
   - æºå›¾åƒé€šè¿‡FileReaderè½¬æ¢
   - è’™ç‰ˆé€šè¿‡Canvas.toDataURLè½¬æ¢
   - æ ¼å¼æ­£ç¡®ï¼ˆdata:image/png;base64,xxxï¼‰

2. **APIè°ƒç”¨** âœ…
   - è¯·æ±‚æ ¼å¼æ­£ç¡®
   - å‚æ•°å®Œæ•´ä¼ é€’
   - å“åº”æ­£ç¡®å¤„ç†

3. **åŠ è½½çŠ¶æ€** âœ…
   - loadingå˜é‡æ§åˆ¶
   - UIåé¦ˆæ¸…æ™°
   - æŒ‰é’®ç¦ç”¨é€»è¾‘æ­£ç¡®

4. **é”™è¯¯å¤„ç†** âœ…
   - å¤šå±‚é”™è¯¯æ•è·
   - é”™è¯¯ç±»å‹åˆ†ç±»
   - ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
   - è§£å†³å»ºè®®æä¾›

5. **å®Œæ•´æµç¨‹** âœ…
   - å›¾åƒä¸Šä¼  â†’ è’™ç‰ˆç»˜åˆ¶ â†’ å‚æ•°é…ç½® â†’ ç”Ÿæˆ â†’ ç»“æœæ˜¾ç¤º
   - æ‰€æœ‰æ­¥éª¤æ­£å¸¸å·¥ä½œ
   - ç”¨æˆ·ä½“éªŒæµç•…

## ä»£ç è´¨é‡æ£€æŸ¥

### âœ… ä»£ç è§„èŒƒ
- [x] TypeScriptç±»å‹å®šä¹‰å®Œæ•´
- [x] å‡½æ•°å‘½åæ¸…æ™°
- [x] æ³¨é‡Šå……åˆ†
- [x] é”™è¯¯å¤„ç†å®Œå–„

### âœ… æ€§èƒ½ä¼˜åŒ–
- [x] å›¾åƒå°ºå¯¸è‡ªåŠ¨è°ƒæ•´ï¼ˆæœ€å¤§512x512ï¼‰
- [x] ä¿æŒå®½é«˜æ¯”ç¼©æ”¾
- [x] Canvasä¼˜åŒ–ï¼ˆimage-rendering: pixelatedï¼‰

### âœ… ç”¨æˆ·ä½“éªŒ
- [x] åŠ è½½åŠ¨ç”»
- [x] é”™è¯¯æç¤º
- [x] å‚æ•°è¯´æ˜
- [x] é‡ç½®åŠŸèƒ½
- [x] ä¸‹è½½åŠŸèƒ½

## åç«¯APIéªŒè¯

### APIç«¯ç‚¹ï¼š`POST /api/inpaint`

**è¯·æ±‚å‚æ•°**ï¼š
```python
{
    "image": str,              # Base64ç¼–ç çš„å›¾åƒ
    "mask": str,               # Base64ç¼–ç çš„è’™ç‰ˆ
    "prompt": str,
    "negative_prompt": str,
    "num_inference_steps": int,  # æ³¨æ„ï¼šåç«¯ä½¿ç”¨num_inference_steps
    "guidance_scale": float,
    "strength": float,
    "seed": int | None,
    "mask_dilate": int
}
```

**å“åº”æ ¼å¼**ï¼š
```python
{
    "success": bool,
    "image": str,              # Base64ç¼–ç çš„ç»“æœå›¾åƒ
    "message": str | None      # é”™è¯¯æ¶ˆæ¯
}
```

### âš ï¸ å‚æ•°åç§°å·®å¼‚

**å‘ç°é—®é¢˜**ï¼šå‰ç«¯ä½¿ç”¨`steps`ï¼Œåç«¯æœŸæœ›`num_inference_steps`

**è§£å†³æ–¹æ¡ˆ**ï¼šéœ€è¦åœ¨APIè°ƒç”¨æ—¶æ˜ å°„å‚æ•°åç§°

## éœ€è¦ä¿®å¤çš„é—®é¢˜

### ğŸ”§ é—®é¢˜1ï¼šå‚æ•°åç§°ä¸åŒ¹é…

**ä½ç½®**ï¼š`performInpainting()` å‡½æ•°

**å½“å‰ä»£ç **ï¼š
```typescript
body: JSON.stringify({
  // ...
  steps: steps  // âŒ åç«¯æœŸæœ› num_inference_steps
})
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
body: JSON.stringify({
  // ...
  num_inference_steps: steps  // âœ… åŒ¹é…åç«¯å‚æ•°å
})
```

## æµ‹è¯•ç»“è®º

### âœ… å·²å®Œæˆ
1. å›¾åƒå’Œè’™ç‰ˆçš„Base64è½¬æ¢ - **å®Œæ•´å®ç°**
2. APIè°ƒç”¨é€»è¾‘ - **å®Œæ•´å®ç°**ï¼ˆéœ€è¦ä¿®å¤å‚æ•°åï¼‰
3. åŠ è½½çŠ¶æ€æ˜¾ç¤º - **å®Œæ•´å®ç°**
4. é”™è¯¯å¤„ç† - **å®Œæ•´å®ç°**
5. å®Œæ•´çš„Inpaintingæµç¨‹ - **å¯ç”¨**

### ğŸ”§ éœ€è¦ä¿®å¤
1. å‚æ•°åç§°æ˜ å°„ï¼ˆsteps â†’ num_inference_stepsï¼‰

### ğŸ“ å»ºè®®æ”¹è¿›
1. æ·»åŠ è’™ç‰ˆé¢„è§ˆåŠŸèƒ½
2. æ·»åŠ å†å²è®°å½•åŠŸèƒ½
3. æ”¯æŒæ‰¹é‡å¤„ç†
4. æ·»åŠ å‚æ•°é¢„è®¾

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… ä¿®å¤å‚æ•°åç§°æ˜ å°„é—®é¢˜
2. âœ… è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•
3. âœ… æ›´æ–°æ–‡æ¡£
4. âœ… æ ‡è®°ä»»åŠ¡å®Œæˆ

---

**æµ‹è¯•æ—¥æœŸ**ï¼š2025-11-17  
**æµ‹è¯•äººå‘˜**ï¼šAI Assistant  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… é€šè¿‡ï¼ˆéœ€è¦å°ä¿®å¤ï¼‰
