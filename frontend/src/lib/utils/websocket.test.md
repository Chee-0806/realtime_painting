# WebSocketManager 测试指南

## 功能测试清单

### 1. 基本连接测试

#### 测试步骤：
1. 打开画板页面 (`/canvas`)
2. 点击"连接服务器"按钮
3. 观察连接状态变化

#### 预期结果：
- ✅ 连接状态从"未连接"变为"连接中..."
- ✅ 成功连接后状态变为"已连接"
- ✅ 状态指示器显示绿色圆点
- ✅ 控制台输出：`✅ WebSocket连接成功，等待后端请求或用户开始发送`

---

### 2. 断线重连测试

#### 测试步骤：
1. 成功连接到服务器
2. 停止后端服务（模拟断线）
3. 观察重连行为

#### 预期结果：
- ✅ 连接状态变为"重连中 (1/5)"
- ✅ 显示错误提示："WebSocket连接断开，正在重连..."
- ✅ 控制台输出重连日志：`🔄 将在 X秒 后重连`
- ✅ 每次重连尝试之间的延迟递增（指数退避）
  - 第1次：1秒
  - 第2次：1.5秒
  - 第3次：2.25秒
  - 第4次：3.375秒
  - 第5次：5.0625秒

---

### 3. 重连成功测试

#### 测试步骤：
1. 触发断线重连
2. 在重连过程中重启后端服务
3. 观察重连成功

#### 预期结果：
- ✅ 连接状态变为"已连接"
- ✅ 重连计数器重置为0
- ✅ 可以正常发送和接收消息
- ✅ 控制台输出：`✅ WebSocket连接成功`

---

### 4. 重连失败测试

#### 测试步骤：
1. 停止后端服务
2. 连接到服务器（触发重连）
3. 等待所有5次重连尝试失败

#### 预期结果：
- ✅ 连接状态变为"连接失败"
- ✅ 显示错误提示："WebSocket重连失败"
- ✅ 错误提示包含建议："刷新页面重新连接"
- ✅ 控制台输出：`❌ 达到最大重连次数 (5)，停止重连`
- ✅ 不再尝试重连

---

### 5. 手动断开测试

#### 测试步骤：
1. 成功连接到服务器
2. 再次点击"连接服务器"按钮（切换为断开）
3. 观察断开行为

#### 预期结果：
- ✅ 连接状态变为"未连接"
- ✅ 状态指示器显示灰色圆点
- ✅ 控制台输出：`🔌 手动断开WebSocket连接`
- ✅ 不会触发自动重连
- ✅ 如果正在发送，自动停止发送

---

### 6. 消息队列测试

#### 测试步骤：
1. 在未连接状态下尝试发送消息
2. 连接到服务器
3. 观察消息是否被发送

#### 预期结果：
- ✅ 未连接时消息被加入队列
- ✅ 控制台输出：`⚠️ WebSocket未连接，消息已加入队列`
- ✅ 连接成功后自动发送队列中的消息
- ✅ 控制台输出：`📤 发送队列中的 X 条消息`

---

### 7. 实时绘画测试

#### 测试步骤：
1. 连接到服务器
2. 点击"开始发送"
3. 在画布上绘画
4. 观察实时生成

#### 预期结果：
- ✅ 绘画时画布内容实时发送到后端
- ✅ 使用防抖机制，不会过于频繁发送
- ✅ 连接断开时自动停止发送
- ✅ 重连成功后可以继续发送

---

### 8. 错误处理测试

#### 测试步骤：
1. 在后端未启动时尝试连接
2. 观察错误提示

#### 预期结果：
- ✅ 显示清晰的错误消息
- ✅ 提供有用的解决建议
- ✅ 错误类型正确（ErrorType.WEBSOCKET）
- ✅ 错误可恢复（recoverable: true）

---

## 性能测试

### 指数退避验证

重连延迟应该按照以下公式计算：
```
delay = min(reconnectDelay * (reconnectDecayRate ^ attempts), maxReconnectDelay)
```

默认配置：
- `reconnectDelay` = 1000ms
- `reconnectDecayRate` = 1.5
- `maxReconnectDelay` = 30000ms

预期延迟序列：
1. 1000ms (1秒)
2. 1500ms (1.5秒)
3. 2250ms (2.25秒)
4. 3375ms (3.375秒)
5. 5062.5ms (5.0625秒)

---

## 集成测试

### 与画板页面集成

#### 测试场景：
1. ✅ 画板页面加载时 WebSocketManager 未初始化
2. ✅ 点击"连接服务器"后创建 WebSocketManager 实例
3. ✅ 连接成功后可以正常绘画和发送
4. ✅ 断线后自动重连，不影响用户操作
5. ✅ 页面卸载时正确清理 WebSocketManager 资源

---

## 浏览器兼容性测试

测试浏览器：
- [ ] Chrome/Edge (Chromium)
- [ ] Firefox
- [ ] Safari
- [ ] 移动端浏览器

---

## 已知限制

1. **消息队列大小**：当前没有限制队列大小，可能导致内存问题
2. **消息顺序**：队列中的消息按FIFO顺序发送，但不保证与实时消息的顺序
3. **二进制消息**：支持发送二进制数据（ArrayBuffer/Blob），但队列功能未充分测试

---

## 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 基本连接 | ⏳ 待测试 | |
| 断线重连 | ⏳ 待测试 | |
| 重连成功 | ⏳ 待测试 | |
| 重连失败 | ⏳ 待测试 | |
| 手动断开 | ⏳ 待测试 | |
| 消息队列 | ⏳ 待测试 | |
| 实时绘画 | ⏳ 待测试 | |
| 错误处理 | ⏳ 待测试 | |

---

## 测试命令

```bash
# 启动前端开发服务器
cd frontend
npm run dev

# 启动后端服务器
cd ..
./start-dev.sh

# 访问画板页面
# http://localhost:5173/canvas
```

---

## 调试技巧

### 查看 WebSocket 连接状态
```javascript
// 在浏览器控制台执行
console.log(wsManager?.getStatus());
console.log(wsManager?.isConnected());
```

### 手动触发重连
```javascript
// 在浏览器控制台执行
wsManager?.resetReconnectAttempts();
wsManager?.connect();
```

### 查看消息队列
```javascript
// 需要在 WebSocketManager 中添加 getter
console.log(wsManager?.messageQueue);
```

---

**测试日期**: 待定  
**测试人员**: 待定  
**版本**: 1.0
